---
title: "Plots_TFE-Inotec"
author: "Ivan Calandra & Lisa Schunk"
date: "`r Sys.time()`"
output: word_document
---

```{r Knitr Options, include=FALSE}
knitr::opts_chunk$set(comment=NA, message=FALSE, indent="", error=TRUE)
```


# Goal of the script
This script plots sensor data in order to visualize the measurements 
recorded throughout the tool function experiment.  
Variables of interest are: 
* Penetration depth 



```{r}
dir_in <- "analysis_ST.all_sensors/derived_data/"
dir_out <- "analysis_ST.all_sensors/plots"

```

Raw data must be located in `r paste0("~/", dir_in)`.  
Formatted data will be saved in `r paste0("~/", dir_out)`.
The knit directory for this script is the project directory.

---


# Load packages
```{r}
library(R.utils)
library(ggplot2)
library(tools)
library(tidyverse)
library(patchwork)
library(doBy)
library(ggrepel)
library(openxlsx)

```


---

# Get name, path and information of the file 
```{r}
data_file <- list.files(dir_in, pattern = "\\.xlsx$", full.names = TRUE)
md5_in <- md5sum(data_file)
info_in <- data.frame(file = basename(names(md5_in)), checksum = md5_in, row.names = NULL)

```


The checksum (MD5 hashes) of the imported file is:  
```{r, echo = FALSE}
info_in

```


# Load data into R object
```{r}
imp_data <- read.xlsx(data_file)
str(imp_data)

```

The imported file is: "`r paste0("~/", data_file)`"  



# Plot each of the selected numeric variable 
## Plots showing the strokes as lines: only the first 50 strokes (= first cycle will be shown) 
```{r}

# exclude the strokes with the wrong/missing values: FLT8-3 -> stroke 1033 - 2000, FLT8-4 -> stroke 243 + 244, FLT8-10 -> stoke 86 - 275, LYDIT5-7 -> 1997 - 2000, LYDIT5-9 ->  251 - 1000, LYDIT5-11 -> 251  - 1000, 
#good_data <- imp_data[-c(410227:419907, 242382:242401, 120833:122735, 359872:359911, 222454:229961, 62498: 69991), ]



good_data <- imp_data


# plots all 2000 strokes per sample divided by 40 
# splits the data in the individual 24 samples
sp <- split(good_data, good_data[["Sample"]])


for (i in seq_along(sp)) {
  # creates a sequence of every ~ 50th strokes 
  seq_st <- seq(1, length(unique(sp[[i]][["Stroke"]])), by = 40) %>% 
            c(max(unique(sp[[i]][["Stroke"]])))

  range_force <- range(dat_i_50[["Force"]])
  range_friction <- range(dat_i_50[["Friction"]])
  range_depth <- range(dat_i_50[["Depth"]])
  range_velocity <- range(dat_i_50[["Velocity"]])

       
# plots only the first 50 strokes per sample  
  dat_i_50 <- sp[[i]] %>% 
              # takes only the first 50 strokes per sample
              filter(Stroke %in% 1:50)
  
    p1 <- ggplot(data = dat_i_50) +
        geom_line(aes(x = Step, y = Force, colour = Stroke, group = Stroke), alpha = 0.3) + 
        labs(x = "Step", y = "Force [N]") + 
        scale_colour_continuous(trans = "reverse") + 
        coord_cartesian(ylim = range_force) +
        scale_x_continuous(breaks=c(1, 4, 7, 10)) +
	      theme_classic()
  print(p1)
  
    p2 <- ggplot(data = dat_i_50) +
        geom_line(aes(x = Step, y = Friction, colour = Stroke, group = Stroke), alpha = 0.3) + 
        labs(x = "Step", y = "Friction [N]") + 
        scale_colour_continuous(trans = "reverse") + 
        coord_cartesian(ylim = range_friction) +
        scale_x_continuous(breaks=c(1, 4, 7, 10)) +
	      theme_classic()
  print(p2)
  
  p3 <- ggplot(data = dat_i_50) +
        geom_line(aes(x = Step, y = Depth, colour = Stroke, group = Stroke), alpha = 0.3) + 
        labs(x = "Step", y = "Depth [mm]") + 
        scale_colour_continuous(trans = "reverse") + 
        coord_cartesian(ylim = range_depth) +
        scale_x_continuous(breaks=c(1, 4, 7, 10)) +
	      theme_classic()
  print(p3)
  
    p4 <- ggplot(data = dat_i_50) +
        geom_line(aes(x = Step, y = Velocity, colour = Stroke, group = Stroke), alpha = 0.3) + 
        labs(x = "Step", y = "Velocity [mm/s]") + 
        scale_colour_continuous(trans = "reverse") + 
        coord_cartesian(ylim = range_velocity) +
        scale_x_continuous(breaks=c(1, 4, 7, 10)) +
	      theme_classic()
  print(p4)
  
  # patchwork plot
  p <- p1 + p2 + p3 + p4 + plot_annotation(title = names(sp)[i]) + plot_layout(ncol = 1, guides = "collect")
  print(p)

  # save to PDF
  file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "_50_plot_", 
	                   names(sp)[i], ".pdf")
  ggsave(filename = file_out, plot = p, path = dir_out, device = "pdf")
} 

```


## Plots showing the strokes as lines: all strokes
```{r}

# exclude the strokes with the wrong/missing values: FLT8-3 -> stroke 1033 - 2000, FLT8-4 -> stroke 243 + 244, FLT8-10 -> stoke 86 - 275, LYDIT5-7 -> 1997 - 2000, LYDIT5-9 ->  251 - 1000, LYDIT5-11 -> 251  - 1000, 
good_data <- imp_data[-c(410227:419907, 242382:242401, 120833:122735, 359872:359911, 222454:229961, 62498: 69991), ]



#good_data <- imp_data


# plots all 2000 strokes per sample divided by 40 
# splits the data in the individual 24 samples
sp <- split(good_data, good_data[["Sample"]])


for (i in seq_along(sp)) {
  # creates a sequence of every ~ 50th strokes 
  seq_st <- seq(1, length(unique(sp[[i]][["Stroke"]])), by = 40) %>% 
            c(max(unique(sp[[i]][["Stroke"]])))
  dat_i_all <- sp[[i]] %>% 
               filter(Stroke %in% seq_st)
  range_force_all <- range(dat_i_all[["Force"]])
  range_friction_all <- range(dat_i_all[["Friction"]])
  range_depth_all <- range(dat_i_all[["Depth"]])
  range_velocity_all <- range(dat_i_all[["Velocity"]])

       
  
    p1b <- ggplot(data = dat_i_all) +
        geom_line(aes(x = Step, y = Force, colour = Stroke, group = Stroke), alpha = 0.3) + 
        labs(x = "Step", y = "Force [N]") + 
        scale_colour_continuous(trans = "reverse") + 
        coord_cartesian(ylim = range_force_all) +
        scale_x_continuous(breaks=c(1, 4, 7, 10)) +
	      theme_classic()
  print(p1b)
  
    p2b <- ggplot(data = dat_i_all) +
        geom_line(aes(x = Step, y = Friction, colour = Stroke, group = Stroke), alpha = 0.3) + 
        labs(x = "Step", y = "Friction [N]") + 
        scale_colour_continuous(trans = "reverse") + 
        coord_cartesian(ylim = range_friction_all) +
        scale_x_continuous(breaks=c(1, 4, 7, 10)) +
	      theme_classic()
  print(p2b)
  
  p3b <- ggplot(data = dat_i_all) +
        geom_line(aes(x = Step, y = Depth, colour = Stroke, group = Stroke), alpha = 0.3) + 
        labs(x = "Step", y = "Depth [mm]") + 
        scale_colour_continuous(trans = "reverse") + 
        coord_cartesian(ylim = range_depth_all) +
        scale_x_continuous(breaks=c(1, 4, 7, 10)) +
	      theme_classic()
  print(p3b)
  
    p4b <- ggplot(data = dat_i_all) +
        geom_line(aes(x = Step, y = Velocity, colour = Stroke, group = Stroke), alpha = 0.3) + 
        labs(x = "Step", y = "Velocity [mm/s]") + 
        scale_colour_continuous(trans = "reverse") + 
        coord_cartesian(ylim = range_velocity_all) +
        scale_x_continuous(breaks=c(1, 4, 7, 10)) +
	      theme_classic()
  print(p4b)
  
  # patchwork plot
  pb <- p1b + p2b + p3b + p4b + plot_annotation(title = names(sp)[i]) + plot_layout(ncol = 1, guides = "collect")
  print(p)

  # save to PDF
  file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "_plot_", 
	                   names(sp)[i], ".pdf")
  ggsave(filename = file_out, plot = pb, path = dir_out, device = "pdf")
} 

```


## Plots showing the relative penetration depths 
### Plot of all samples 
```{r}

# calculates the relative depths reached per sample
rel.depth <- function(x) {
  no.na <- x[!is.na(x)]
  out <- min(no.na) - x[1]
  return(out)
}

# Define grouping variable and compute the summary statistics 
depth <- summaryBy(Depth ~ Sample+Angle+Task+Raw_material, 
                  data=good_data, 
                  FUN=rel.depth)

str(depth)

# colour 
depth[["Raw_material"]] <- factor(depth[["Raw_material"]])
#Royal1 = c("#899DA4", "#C93312", "#FAEFD1", "#DC863B")
custom.col7 <- data.frame(type = levels(depth$Raw_material), 
                           col = c("#899DA4", "#DC863B")) 
depth$col <- custom.col7[depth$Raw_material, "col"]


# plots all depth points in one facet plot 
p3 <- ggplot(data = depth, aes(x = Angle, y = Depth.rel.depth, colour = Raw_material)) +
       geom_point() + labs(y = "Relative depth (mm)") +
       facet_wrap(~Task, strip.position = "bottom") +
       # avoids overplotting of the labels (sample IDs)
       geom_text_repel(aes(label=Sample), size = 2, nudge_x = -0.4, 
                       segment.size = 0.1, force = 2, seed = 123) +
       scale_y_continuous(trans = "reverse") +
       scale_x_discrete(position="top") +
       # removes the "_" between "Raw_material in the legend 
	     labs(colour = gsub("_", " ", "Raw_material")) + 
       scale_colour_manual(values = custom.col7$col) + 
	     theme_classic()
print(p3)

# save to PDF
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "_P3_depth_plot", ".pdf")
ggsave(filename = file_out, plot = p3, path = dir_out, device = "pdf", 
       width = 180, units = "mm")


```

### Plot of all samples except the three outliers 
```{r}
# defines the outlier (FLT8-10 is here defined as outlier, because the result of this sample is not comparable to the other samples)
bad_sample <- "FLT8-10"
# creates data frames without the outlier
good_data_outlier <- good_data[!good_data$Sample %in% bad_sample, ]
# splits the data in the individual 21 samples
sp_good <- split(good_data_outlier, good_data_outlier[["Sample"]])


# Define grouping variable and compute the summary statistics 
depth_good <- summaryBy(Depth ~ Sample + Angle + Task + Raw_material, data = good_data_outlier, 
                  FUN = rel.depth)

str(depth_good)

# plots all depth points in one facet plot 
p4 <- ggplot(data = depth_good, aes(x = Angle, y = Depth.rel.depth, 
                                    colour = Raw_material)) +
       geom_point() + labs(y = "Relative depth (mm)") +
       facet_wrap(~Task, strip.position = "bottom") +
       geom_text_repel(aes(label=Sample), size = 2, 
                       nudge_x = -0.4, segment.size = 0.1, force = 2, seed = 123) +
       scale_y_continuous(trans = "reverse") +
       scale_x_discrete(position="top") +
       # removes the "_" between "Raw_material in the legend 
	     labs(colour = gsub("_", " ", "Raw_material")) + 
       scale_colour_manual(values = custom.col7$col) + 
	     theme_classic()
print(p4)

# save to PDF
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "_P4_depth_plot", ".pdf")
ggsave(filename = file_out, plot = p4, path = dir_out, device = "pdf", 
       width = 180, units = "mm")

```

The files will be saved as "`r paste0("~/", dir_out, ".[ext]")`".

---
# Save data
## Write to XLSX (summary statistics)
```{r}
write.xlsx(list(depth = depth, depth_good = depth_good), 
           file = paste0(dir_out, file_out, ".xlsx"))

```


-
---

# sessionInfo() and RStudio version

```{r}
sessionInfo()

```

RStudio version `r readLines("analysis/scripts/RStudioVersion.txt", n = 1)`.


---

END OF SCRIPT

