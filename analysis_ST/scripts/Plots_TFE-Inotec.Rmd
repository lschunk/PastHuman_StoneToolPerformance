---
title: "Plots_TFE-Inotec"
author: "Ivan Calandra & Lisa Schunk"
date: "`r Sys.time()`"
output: 
    html_document:
    df_print: paged
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

```{r Knitr Options, include=FALSE}
knitr::opts_chunk$set(comment=NA, message=FALSE, indent="", error=TRUE)
```


# Goal of the script
This script plots sensor data in order to visualize the measurements 
recorded throughout the tool function experiment.
Variables of interest are: 
* Penetration depth 



```{r}
dir_in <- "analysis_ST/derived_data/"
dir_out <- "analysis_ST/plots"

```

Raw data must be located in `r paste0("~/", dir_in)`.  
Formatted data will be saved in `r paste0("~/", dir_out)`.
The knit directory for this script is the project directory.

---


# Load packages
```{r Libraries}
pack_to_load <- c("tidyverse", "R.utils", "openxlsx", "tools", 
                  "patchwork", "doBy", "ggrepel", "ggplot2")
sapply(pack_to_load, library, character.only = TRUE, logical.return = TRUE)

```


---

# Get name, path and information of the file 
```{r}
data_file <- list.files(dir_in, pattern = "\\.xlsx$", full.names = TRUE)
md5_in <- md5sum(data_file)
info_in <- data.frame(file = basename(names(md5_in)), checksum = md5_in, row.names = NULL)

```


# Load data into R object
```{r}
imp_data <- read.xlsx(data_file)
str(imp_data)

```

The imported file is: "`r paste0("~/", data_file)`"  



# Plot each of the selected numeric variable 
## Plots showing the strokes as lines 
```{r}
# exclude the strokes with the wrong/missing values: FLT8-3 -> stroke 1032 - 2000, FLT8-4 ->   stroke 243 + 244 + 1921, LYDIT5-7 -> 1997 - 2000 
good_data <- imp_data[-c(410218:419907, 242382:242401, 259107:259116,359872:359911), ]

# good_data <- imp_data


# plot all 2000 strokes per sample divided by 40 
# split the data in the individual 24 samples
sp <- split(good_data, good_data[["Sample"]])


for (i in seq_along(sp)) {
  # create a sequence of every ~ 50th strokes 
  seq_st <- seq(1, length(unique(sp[[i]][["Stroke"]])), by = 40) %>% 
            c(max(unique(sp[[i]][["Stroke"]])))
  dat_i_all <- sp[[i]] %>% 
               filter(Stroke %in% seq_st)
  range_depth <- range(dat_i_all[["Depth"]])
  p1 <- ggplot(data = dat_i_all, aes(x = Step, y = Depth, colour = Stroke)) +
        geom_line(aes(group = Stroke), alpha = 0.3) + 
        labs(x = "Step", y = "Depth (mm)") + ylab(NULL) +
        # reverse the legend starting with 0 going to 2000 strokes    
        scale_colour_continuous(trans = "reverse") + 
        coord_cartesian(ylim = range_depth) +
        # change the 'Step-number' in the x-legend  
        scale_x_continuous(breaks=c(1, 4, 7, 10)) +
	      theme_classic()
       
# plot only the first 50 strokes per sample  
  dat_i_50 <- sp[[i]] %>% 
              # take only the first 50 strokes per sample
              filter(Stroke %in% 1:50)
  p2 <- ggplot(data = dat_i_50) +
        geom_line(aes(x = Step, y = Depth, colour = Stroke, group = Stroke), alpha = 0.3) + 
        labs(x = "Step", y = "Depth (mm)") + 
        scale_colour_continuous(trans = "reverse") + 
        coord_cartesian(ylim = range_depth) +
        scale_x_continuous(breaks=c(1, 4, 7, 10)) +
	      theme_classic()
  
  # patchwork plot
  p <- p2 + p1 + plot_annotation(title = names(sp)[i]) 
  print(p)

  # save to PDF
  file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "_plot_", 
	                   names(sp)[i], ".pdf")
  ggsave(filename = file_out, plot = p, path = dir_out, device = "pdf")
} 

```


## Plots showing the relative penetration depths 
### Plot of all samples 
```{r}
# calculate the relative depths reached per sample
rel.depth <- function(x) {
  no.na <- x[!is.na(x)]
  out <- min(no.na) - x[1]
  return(out)
}

# define grouping variable and compute the summary statistics 
depth <- summaryBy(Depth ~ Sample+Angle+Task+Raw_material, 
                  data=good_data, 
                  FUN=rel.depth)

str(depth)

# colour 
depth[["Raw_material"]] <- factor(depth[["Raw_material"]])
custom.col7 <- data.frame(type = levels(depth$Raw_material), 
                           col = c("#899DA4", "#DC863B")) 
depth$col <- custom.col7[depth$Raw_material, "col"]


# plot all depth points in one facet plot 
p3 <- ggplot(data = depth, aes(x = Angle, y = Depth.rel.depth, colour = Raw_material)) +
       geom_point() + labs(y = "Relative depth (mm)") +
       facet_wrap(~Task, strip.position = "bottom") +
       # avoid overplotting of the labels (sample IDs)
       geom_text_repel(aes(label=Sample), size = 2, nudge_x = -0.4, 
                       segment.size = 0.1, force = 2, seed = 123) +
       scale_y_continuous(trans = "reverse") +
       scale_x_discrete(position="top") +
       # remove the "_" between "Raw_material in the legend 
	     labs(colour = gsub("_", " ", "Raw_material")) + 
       scale_colour_manual(values = custom.col7$col) + 
	     theme_classic()

print(p3)

# save to PDF
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "_P3_depth_plot", ".pdf")
ggsave(filename = file_out, plot = p3, path = dir_out, device = "pdf", 
       width = 180, units = "mm")

```


```{r}
# calculate the absolute depths reached per sample
abs.depth <- function(x) {
  out <- abs(min(x) - max(x))
}

# define grouping variable and compute the summary statistics 
depth <- summaryBy(Depth ~ Sample+Angle+Task+Raw_material, 
                  data=imp_data, 
                  FUN=abs.depth)

str(depth)

# colour 
depth[["Raw_material"]] <- factor(depth[["Raw_material"]])
custom.col7 <- data.frame(type = levels(depth$Raw_material), 
                           col = c("#899DA4", "#DC863B")) 
depth$col <- custom.col7[depth$Raw_material, "col"]


# plot all depth points in one facet plot 
p3b <- ggplot(data = depth, aes(x = Angle, y = Depth.abs.depth, colour = Raw_material)) +
       geom_point() + labs(y = "Absolute depth (mm)") +
       facet_wrap(~Task, strip.position = "bottom") +
       # avoid overplotting of the labels (sample IDs)
       geom_text_repel(aes(label=Sample), size = 2, nudge_x = -0.4, 
                       segment.size = 0.1, force = 2, seed = 123) +
       scale_y_continuous(trans = "reverse") +
       scale_x_discrete(position="top") +
       # remove the "_" between "Raw_material in the legend 
	     labs(colour = gsub("_", " ", "Raw_material")) + 
       scale_colour_manual(values = custom.col7$col) + 
	     theme_classic()

print(p3b)

# save to PDF
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "_P3b_depth_plot", ".pdf")
ggsave(filename = file_out, plot = p3b, path = dir_out, device = "pdf", 
       width = 180, units = "mm")

```


### Plot of all samples except the three outliers 
```{r}
# define the outlier (FLT8-10 is here defined as outlier, because the result of this sample   is not comparable to the other samples)
bad_sample <- "FLT8-10"
# create data frames without the outlier
good_data_outlier <- good_data[!good_data$Sample %in% bad_sample, ]
# split the data in the individual 21 samples
sp_good <- split(good_data_outlier, good_data_outlier[["Sample"]])


# define grouping variable and compute the summary statistics 
depth_good <- summaryBy(Depth ~ Sample + Angle + Task + Raw_material, data = good_data_outlier, 
                  FUN = rel.depth)

str(depth_good)

# plot all depth points in one facet plot 
p4 <- ggplot(data = depth_good, aes(x = Angle, y = Depth.rel.depth, 
                                    colour = Raw_material)) +
       geom_point() + labs(y = "Relative depth (mm)") +
       facet_wrap(~Task, strip.position = "bottom") +
       geom_text_repel(aes(label=Sample), size = 2, 
                       nudge_x = -0.4, segment.size = 0.1, force = 2, seed = 123) +
       scale_y_continuous(trans = "reverse") +
       scale_x_discrete(position="top") +
       # remove the "_" between "Raw_material in the legend 
	     labs(colour = gsub("_", " ", "Raw_material")) + 
       scale_colour_manual(values = custom.col7$col) + 
	     theme_classic()

print(p4)

# save to PDF
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "_P4_depth_plot", ".pdf")
ggsave(filename = file_out, plot = p4, path = dir_out, device = "pdf", 
       width = 180, units = "mm")

```

The files will be saved as "`r paste0("~/", dir_out, ".[ext]")`".

-
---

# sessionInfo() and RStudio version

```{r}
sessionInfo()

```

RStudio version `r readLines("RStudioVersion.txt", n = 1)`.


# Cite R packages used
```{r Citation}
for (i in pack_to_load) print(citation(i), bibtex = FALSE)

```


---

END OF SCRIPT

