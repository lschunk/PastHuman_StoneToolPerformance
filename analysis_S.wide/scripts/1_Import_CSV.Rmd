---
title: "Import CSV from ConfoMap - cut marks/grooves"
author: "Lisa Schunk"
date: "`r Sys.time()`"
output:
  html_document:
    df_print: paged
---


```{r Knitr Options, include=FALSE}
knitr::opts_chunk$set(comment = NA, message = FALSE, indent = "", error = TRUE)

```

---


# Goal of the script
This script formats the output of the resulting CSV-file from applying a template computing the width and the depth of cut marks/grooves in bone plates in ConfoMap.
The script will:

1. Read in the original CSV-file   
2. Format the data   
3. Write an XLSX-file and save an R object ready for further analysis in R 

```{r}
dir_in <- "analysis_S.wide/raw_data"
dir_out <- "analysis_S.wide/derived_data/"

```

Raw data must be located in `r paste0("~/", dir_in)`.  
Formatted data will be saved in `r paste0("~/", dir_out)`.

The knit directory for this script is the project directory.

---


# Load packages
```{r Libraries}
pack_to_load <- c("chron", "R.utils", "openxlsx", "tools")
sapply(pack_to_load, library, character.only = TRUE, logical.return = TRUE)

```


---


# Get names, path and information of the file 
```{r}
data_file <- list.files(dir_in, pattern = "\\.csv$", full.names = TRUE)

```


The imported file is:  
```{r, echo = FALSE}
data_file

```


---


# Read in original CSV-file
```{r}
imp_data <- read.csv(data_file, header = FALSE)
str(imp_data)

```


---


# Format data
## Keep only interesting columns and rows
```{r}
# keep only the columns and rows of interest for the analysis 
data_keep_col <- c(1:2, 4, 6:8, 10:12, 15:18)
data_keep_rows <- which(imp_data[[1]] != "#")
data_keep <- imp_data[data_keep_rows, data_keep_col]

```


## Add headers
```{r}
head_data_keep <- unlist(imp_data[2, data_keep_col]) 
colnames(data_keep) <- gsub("\\.+", "\\.", make.names(head_data_keep))
colnames(data_keep) <- gsub("\\.$", "", colnames(data_keep)) 
colnames(data_keep)[12:13] <- c("Width", "Depth")
colnames(data_keep)[11] <- gsub("\\.1$", "", colnames(data_keep)[11])

```


## Save units
```{r}
# take the units which were part of the headers and separates them; create a data frame
var_num <- 4:13
# extract 'unit' line for considered columns
units_var <- unlist(imp_data[3, data_keep_col])[var_num] 
# get names associated to the units
names(units_var) <- colnames(data_keep)[var_num] 
# put all of it into a data.frame
units_var_table <- data.frame(variable = names(units_var), unit = units_var) 

```


## Convert to numeric
```{r}
for (i in var_num) data_keep[[i]] <- as.numeric(data_keep[[i]])

```


## Split the column 'Name' into several columns
```{r}
# split the ID in the separate information 
split_name <- do.call(rbind, strsplit(data_keep[["Name"]], "_"))

# add these columns to data_keep and rename columns
data_final <- data.frame(split_name, data_keep[-3], stringsAsFactors = FALSE)
colnames(data_final)[1:9] <- c("Bone.plate", "Equipment", "Movement", "Strokes", "Acquisition.date",
                               "Sample", "Edge.angle", "Analysis.date", "Analysis.time")

```


## Add or edit columns about experiment, bone plate, sample raw material and edge angle
```{r}
# extract the experiment based on the Bone.plate
data_final[["Experiment"]] <- gsub("BP-I+-", "", data_final[["Bone.plate"]])

# edit the Bone.plate column
data_final[["Bone.plate"]] <- gsub("-TFE", "", data_final[["Bone.plate"]])

# extract the raw material based on the Sample
data_final[grep("FLT", data_final[["Sample"]]), "Raw.material"] <- "flint"
data_final[grep("LYDIT", data_final[["Sample"]]), "Raw.material"] <- "lydite"

# edit Edge.angle
data_final[["Edge.angle"]] <- gsub("deg", "Â°", data_final[["Edge.angle"]])

```


## Convert dates and times
```{r}
data_final$Analysis.date <- as.Date(data_final$Analysis.date, format = "%d.%m.%Y")
data_final$Analysis.time <- times(data_final$Analysis.time)
data_final$Acquisition.date <- as.Date(data_final$Acquisition.date, format = "%Y%m%d")

```


## Ignore some columns and reorder columns
```{r}
data_final <- data_final[c(2, 5, 8:9, 20, 1, 21, 6, 3:4, 7, 10:19)]

```


## Add units as comment()
```{r}
comment(data_final) <- units_var

```

Type `comment(data_final)` to check the units of the columns.


## Check the result
```{r}
str(data_final)
head(data_final)

```


---


# Save data
## Format name of output file
```{r}
file_out <- "cut.marks_bone.plates"

```
The files will be saved as "`r paste0("~/", file_out, ".[ext]")`".


## Write to XLSX
```{r}
write.xlsx(list(data = data_final, units = units_var_table), 
           file = paste0(dir_out, file_out, ".xlsx"))

```


## Save R object
```{r}
saveObject(data_final, file = paste0(dir_out, file_out, ".Rbin"))

```

---

# sessionInfo() and RStudio version

```{r}
sessionInfo()
```

RStudio version `r readLines("analysis/scripts/RStudioVersion.txt", n = 1)`.


---

# Cite R packages used
```{r Citation}
for (i in pack_to_load) print(citation(i), bibtex = FALSE)

```


---


END OF SCRIPT
